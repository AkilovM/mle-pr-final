Яндекс Практикум, MLE, Спринт 6, Финальный проект.
-

Выбрал Кейс 1: Рекомендации банковских продуктов.

---

Скачиваем датасет:

```
mkdir dataset
cd dataset
wget https://getfile.dokpub.com/yandex/get/https://disk.yandex.com/d/Io0siOESo2RAaA
mv Io0siOESo2RAaA train_ver2.csv.zip
sudo apt install unzip
unzip train_ver2.csv.zip
cd ..
```

---

Настраиваем виртуальное окружение для Python:

```
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install "uvicorn[standard]"
```

---

Проводим разведочный анализ данных в ноутбуке `Exploratory_Data_Analysis.ipynb`.

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/AkilovM/mle-pr-final/blob/main/Exploratory_Data_Analysis.ipynb)

---

Установка Airflow :

`sh install_airflow.sh`

Запуск Airflow :

`docker compose up --build`

Остановка Airflow :

`docker compose down`

---

Запуск MLFlow :

`mlflow server --backend-store-uri sqlite:///mlruns.db`

---

Трансляция. Выбираем метрики, на которые хотим повлиять, и рассуждаем как решать задачу.
-
Вероятнее всего это задача мультиклассовой классификации с пересекающимися классами.
Для оценки качества модели можем воспользоваться метрикой `f1-score` (или `recall` если можем позволить себе ложноположительные предсказания).
Выявление всех положительных случаев очень ценно, а ложно-положительные случаи могут создать лишнюю работу\затраты.

Предположим, что исходя из формата данных будущий сервис рекомендаций продуктов будет использоваться для каждого клиента 1 раз в месяц.

Для baseline решения просто почистим данные, закинем в randomforest или catboost. Для выборок обучения и теста стоит взять только один месяц, чтобы не было утечки данных.

Для более продвинутого решения есть разные опции:
- нагенерировать признаки (пример: динамика `renta` за последние 3 месяца);
- пропуски закодировать как отдельный признак;
- перестроить таргеты по принципу `пользователь начал пользоваться этим продуктом в следующем месяце`;

Подробнее про перестройку таргетов:
- `0 -> 1` клиент в прошлом месяце не имел вклада, а в текущем решил вложить.
- `1 -> 0` клиент перестал пользоваться определённым продуктом. Такой случай означает, что либо истек срок (как и запланировано), либо клиент досрочно отказался от продукта (что нежелательно). У нас нет информации о договорах, предполагаемых сроках предоставления услуг и т.д. Тут мы можем только гадать.
- `1 -> 1` клиент в прошлом месяце имел вклад, и в текущем месяце вклад согласно договору продолжает лежать в банке. Либо он перезаключил договор после истечения срока. Тут тоже можем только гадать.
- `0 -> 0` клиент не пользуется продуктом. 

Самый понятный и полезный случай - `0 -> 1`. Клиент начал пользоваться новым продуктом. Именно этот случай будет в таргетах равен 1.0 , остальные 0.0. Можно сместить таргет в следующий месяц, чтобы получилась интерпретация `"такое состояние клиента в начале месяца привело к покупке продукта в течение месяца"`.

---

Эксперименты в ноутбуке `experiments.ipynb`

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/AkilovM/mle-pr-final/blob/main/experiments.ipynb)

---

Описание структуры API для обращения к веб-сервису модели

Запуск веб-сервиса локально:

```
cd app
uvicorn main:app --reload
```

Собрать образ:

```
cp prod_obj.pkl docker_webservice/
cp model_baseline_LogReg.pkl docker_webservice/
cd docker_webservice
docker image build . --tag spain_bank_ml_webservice:0
```

Запустить контейнер с веб-сервисом:

```
docker container run --publish 4600:1702 --env-file .env spain_bank_ml_webservice:0
```

Пример запроса для предсказания:

`http://IP:4600/api/predict_products/657790`

Пример вывода:

```
{
  "user_id": "657790",
  "predicted_products": {
    "Сберегательный счёт": 0,
    "Банковская гарантия": 0,
    "Текущие счета": 1,
    "Деривативный счёт": 0,
    "Зарплатный проект": 0,
    "Детский счёт": 0,
    "Особый счёт 3": 0,
    "Особый счёт": 0,
    "Особый счёт 2": 0,
    "Краткосрочный депозит": 0,
    "Среднесрочный депозит": 0,
    "Долгосрочный депозит": 0,
    "Цифровой счёт": 0,
    "Денежный средства": 0,
    "Ипотека": 0,
    "Пенсионный план": 0,
    "Кредит": 0,
    "Налоговый счёт": 0,
    "Кредитная карта": 0,
    "Ценные бумаги": 0,
    "Домашний счёт": 0,
    "Аккаунт для выплаты зарплаты": 0,
    "Аккаунт для пенсионных обязательств": 0,
    "Дебетовый аккаунт": 0
  }
}
```
---

Мониторинг, описание метрик.

Мониторим:
- время обработки запроса (`rate(http_request_duration_seconds_count[1m])`);
- общее кол-во предсказаний (`main_app_predictions`);
- кол-во положительных предсказаний (`positive_predictions_counter`).
